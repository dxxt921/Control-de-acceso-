<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Access System - Dashboard</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        dark: {
                            100: '#1e293b',
                            200: '#1a2234',
                            300: '#151c2c',
                            400: '#111827',
                            500: '#0d1321',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .gradient-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
        }

        .pulse-dot {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(1.1);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .table-row-new {
            animation: highlightNew 2s ease-out;
        }

        @keyframes highlightNew {
            0% {
                background-color: rgba(14, 165, 233, 0.3);
            }

            100% {
                background-color: transparent;
            }
        }

        .stat-card {
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
        }

        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .status-granted {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1));
            border-color: rgba(34, 197, 94, 0.4);
            color: #86efac;
        }

        .status-denied {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
            border-color: rgba(239, 68, 68, 0.4);
            color: #fca5a5;
        }

        .status-unknown {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.2), rgba(234, 179, 8, 0.1));
            border-color: rgba(234, 179, 8, 0.4);
            color: #fde047;
        }

        /* Enrollment Styles */
        .enrollment-pulse {
            animation: enrollmentPulse 1.5s ease-in-out infinite;
        }

        @keyframes enrollmentPulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.4);
            }

            50% {
                box-shadow: 0 0 0 15px rgba(14, 165, 233, 0);
            }
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .device-row:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .btn-touch {
            min-height: 48px;
            min-width: 48px;
        }

        /* Mobile responsive table */
        @media (max-width: 640px) {
            .mobile-scroll-x {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .mobile-scroll-x table {
                min-width: 500px;
            }
        }
    </style>
</head>

<body class="gradient-bg min-h-screen text-gray-100">

    <!-- Header -->
    <header class="glass border-b border-gray-700/50 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div
                        class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary-400 to-primary-600 flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                        </svg>
                    </div>
                    <div>
                        <h1
                            class="text-xl font-bold bg-gradient-to-r from-primary-300 to-primary-500 bg-clip-text text-transparent">
                            IoT Access System
                        </h1>
                        <p class="text-xs text-gray-400">Dashboard de Monitoreo</p>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <!-- Config Button (siempre visible) -->
                    <button onclick="openConfigModal()"
                        class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-gray-700/50 border border-gray-600/50 hover:bg-gray-600/50 transition text-gray-300"
                        title="Configuraci√≥n">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <span class="hidden sm:inline text-sm">Configuraci√≥n</span>
                    </button>

                    <!-- Session Active Elements -->
                    <th:block th:if="${sessionStatus.active}">
                        <!-- Connection Status -->
                        <div id="connectionStatus"
                            class="flex items-center space-x-2 px-3 py-1.5 rounded-lg bg-green-500/20 border border-green-500/40">
                            <div class="w-2 h-2 rounded-full bg-green-400 pulse-dot"></div>
                            <span class="text-sm text-green-300" th:text="${sessionStatus.portName}">COM3</span>
                        </div>

                        <!-- WebSocket Status -->
                        <div id="wsStatus"
                            class="flex items-center space-x-2 px-3 py-1.5 rounded-lg bg-yellow-500/20 border border-yellow-500/40">
                            <div class="w-2 h-2 rounded-full bg-yellow-400"></div>
                            <span class="text-sm text-yellow-300">En vivo</span>
                        </div>

                        <span class="text-sm text-gray-400" id="currentTime"></span>

                        <!-- Reconnect Button -->
                        <button onclick="openReconnectModal()"
                            class="flex items-center gap-2 px-4 py-2 rounded-lg bg-amber-500/20 border border-amber-500/40 hover:bg-amber-500/30 transition text-amber-300"
                            title="Reconectar Arduino al mismo CSV">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Reconectar
                        </button>

                        <!-- Stop Button -->
                        <button onclick="confirmStop()"
                            class="flex items-center gap-2 px-4 py-2 rounded-lg bg-red-500/20 border border-red-500/40 hover:bg-red-500/30 transition text-red-300">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                            </svg>
                            Detener
                        </button>
                    </th:block>

                    <!-- No Session Elements -->
                    <th:block th:unless="${sessionStatus.active}">
                        <span class="text-sm text-gray-400" id="currentTime"></span>
                        <div
                            class="flex items-center space-x-2 px-3 py-1.5 rounded-lg bg-gray-700/50 border border-gray-600/40">
                            <div class="w-2 h-2 rounded-full bg-gray-500"></div>
                            <span class="text-sm text-gray-400">Sin sesi√≥n</span>
                        </div>
                    </th:block>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <!-- Total Accesos -->
            <div class="stat-card glass-card rounded-2xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400 mb-1">Total Accesos</p>
                        <p class="text-3xl font-bold text-white" id="statTotal" th:text="${stats.totalAccesses()}">0
                        </p>
                    </div>
                    <div class="w-12 h-12 rounded-xl bg-primary-500/20 flex items-center justify-center">
                        <svg class="w-6 h-6 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Permitidos -->
            <div class="stat-card glass-card rounded-2xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400 mb-1">Permitidos</p>
                        <p class="text-3xl font-bold text-green-400" id="statGranted" th:text="${stats.grantedCount()}">
                            0</p>
                    </div>
                    <div class="w-12 h-12 rounded-xl bg-green-500/20 flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Denegados -->
            <div class="stat-card glass-card rounded-2xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400 mb-1">Denegados</p>
                        <p class="text-3xl font-bold text-red-400" id="statDenied" th:text="${stats.deniedCount()}">
                            0
                        </p>
                    </div>
                    <div class="w-12 h-12 rounded-xl bg-red-500/20 flex items-center justify-center">
                        <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- √öltimo Acceso -->
            <div class="stat-card glass-card rounded-2xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400 mb-1">√öltimo Acceso</p>
                        <p class="text-3xl font-bold text-white" id="statLastAccess"
                            th:text="${stats.lastAccessTime()}">--:--:--</p>
                    </div>
                    <div class="w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center">
                        <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Status Panel -->
        <div class="glass-card rounded-2xl p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                    </svg>
                    Estado del Sistema
                </h2>
                <button onclick="loadSystemStatus()"
                    class="text-xs text-gray-400 hover:text-gray-200 transition flex items-center gap-1">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Actualizar
                </button>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Serial Listener -->
                <div class="rounded-xl bg-gray-800/50 border border-gray-700/50 p-4">
                    <div class="flex items-center gap-3 mb-2">
                        <div id="sysSerialDot" class="w-2.5 h-2.5 rounded-full bg-gray-500"></div>
                        <span class="text-sm font-medium text-gray-300">Serial Listener</span>
                    </div>
                    <p id="sysSerialInfo" class="text-xs text-gray-500 ml-5">Cargando...</p>
                </div>
                <!-- Batch Processing -->
                <div class="rounded-xl bg-gray-800/50 border border-gray-700/50 p-4">
                    <div class="flex items-center gap-3 mb-2">
                        <div id="sysBatchDot" class="w-2.5 h-2.5 rounded-full bg-gray-500"></div>
                        <span class="text-sm font-medium text-gray-300">Proceso Batch</span>
                    </div>
                    <p id="sysBatchInfo" class="text-xs text-gray-500 ml-5">Cargando...</p>
                    <div class="flex items-center gap-2 mt-3 ml-5">
                        <input type="time" id="batchTimeInput" value="22:00"
                            class="bg-gray-700/50 border border-gray-600 rounded-lg text-xs text-gray-300 px-2 py-1 focus:border-cyan-500 focus:outline-none" />
                        <button onclick="rescheduleBatch()"
                            class="text-xs bg-cyan-600/30 hover:bg-cyan-600/50 text-cyan-300 px-3 py-1 rounded-lg transition">
                            Programar
                        </button>
                    </div>
                </div>
                <!-- Registered Users -->
                <div class="rounded-xl bg-gray-800/50 border border-gray-700/50 p-4">
                    <div class="flex items-center gap-3 mb-2">
                        <svg class="w-4 h-4 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <span class="text-sm font-medium text-gray-300">Usuarios</span>
                    </div>
                    <p id="sysUsersInfo" class="text-xs text-gray-500 ml-5">Cargando...</p>
                </div>
                <!-- WebSocket Clients -->
                <div class="rounded-xl bg-gray-800/50 border border-gray-700/50 p-4">
                    <div class="flex items-center gap-3 mb-2">
                        <svg class="w-4 h-4 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.14 0M1.394 9.393c5.857-5.858 15.355-5.858 21.213 0" />
                        </svg>
                        <span class="text-sm font-medium text-gray-300">Clientes WS</span>
                    </div>
                    <p id="sysWsInfo" class="text-xs text-gray-500 ml-5">Cargando...</p>
                </div>
            </div>
        </div>

        <!-- Session Info Bar -->
        <div class="glass rounded-xl p-4 mb-6 flex items-center justify-between">
            <div class="flex items-center gap-6">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span class="text-sm text-gray-300" th:text="${sessionStatus.sessionName}">sesion_test</span>
                </div>
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="text-sm text-gray-300">Inicio: <span
                            th:text="${sessionStatus.startTime}">00:00:00</span></span>
                </div>
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                    </svg>
                    <span class="text-sm text-gray-300" id="recordCount">
                        <span th:text="${sessionStatus.recordCount}">0</span> registros
                    </span>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <!-- Test Button -->
                <button onclick="simulateAccess()"
                    class="flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-700/50 hover:bg-gray-600/50 transition text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    Test
                </button>

                <!-- Manual Batch Button -->
                <button onclick="runManualBatch()"
                    class="flex items-center gap-2 px-4 py-2 rounded-lg bg-purple-500/20 border border-purple-500/40 hover:bg-purple-500/30 transition text-purple-300 text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    Ejecutar Batch
                </button>
            </div>
        </div>

        <!-- ========== GESTI√ìN DE DISPOSITIVOS ========== -->
        <div class="glass-card rounded-2xl overflow-hidden mb-8">
            <div class="p-6 border-b border-gray-700/50">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                        Gesti√≥n de Dispositivos
                    </h2>

                    <!-- Enrollment Button -->
                    <button id="enrollBtn" onclick="startEnrollment()"
                        class="btn-touch flex items-center justify-center gap-2 px-6 py-3 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 transition-all text-white font-semibold shadow-lg shadow-emerald-500/25">
                        <svg id="enrollIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span id="enrollBtnText">ESCANEAR NUEVO</span>
                    </button>
                </div>

                <!-- Admin Validation Banner -->
                <div id="adminBanner" class="hidden mt-4 p-4 rounded-xl bg-yellow-500/20 border border-yellow-500/40">
                    <div class="flex items-center gap-3">
                        <div class="enrollment-pulse">
                            <svg class="w-8 h-8 text-yellow-400" fill="none" viewBox="0 0 24 24">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                            </svg>
                        </div>
                        <div class="flex-1">
                            <p class="text-yellow-300 font-medium">üîê Autorizaci√≥n Requerida</p>
                            <p class="text-sm text-yellow-400/70">Acerque la tarjeta del ADMINISTRADOR</p>
                        </div>
                        <div class="text-3xl font-bold text-yellow-300" id="adminCountdown">15</div>
                        <button onclick="cancelEnrollment()" class="ml-2 p-2 rounded-lg hover:bg-white/10 transition">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Enrollment Status Banner -->
                <div id="enrollmentBanner"
                    class="hidden mt-4 p-4 rounded-xl bg-primary-500/20 border border-primary-500/40">
                    <div class="flex items-center gap-3">
                        <div class="enrollment-pulse">
                            <svg class="w-8 h-8 text-primary-400 spinner" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <p class="text-primary-300 font-medium">‚úÖ Admin Verificado - Esperando dispositivo
                                NFC...
                            </p>
                            <p class="text-sm text-primary-400/70">Acerque el dispositivo a registrar</p>
                        </div>
                        <div class="text-3xl font-bold text-primary-300" id="enrollCountdown">20</div>
                        <button onclick="cancelEnrollment()" class="ml-2 p-2 rounded-lg hover:bg-white/10 transition">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Devices Table -->
            <div class="mobile-scroll-x overflow-y-auto max-h-[300px] scrollbar-thin">
                <table class="w-full">
                    <thead class="sticky top-0 bg-gray-800/90 backdrop-blur">
                        <tr class="text-left text-xs text-gray-400 uppercase tracking-wider">
                            <th class="px-6 py-3">Hardware ID (UID)</th>
                            <th class="px-6 py-3">Nombre</th>
                            <th class="px-6 py-3">Fecha de Alta</th>
                            <th class="px-6 py-3 text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="devicesTableBody" class="divide-y divide-gray-700/50">
                        <!-- Devices will be loaded dynamically -->
                        <tr id="devicesEmptyRow">
                            <td colspan="4" class="px-6 py-8 text-center">
                                <svg class="w-10 h-10 mx-auto text-gray-600 mb-2" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                        d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                </svg>
                                <p class="text-gray-500">No hay dispositivos registrados</p>
                                <p class="text-sm text-gray-600 mt-1">Presione "ESCANEAR NUEVO" para agregar</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Access Logs Table -->
        <div class="glass-card rounded-2xl overflow-hidden">
            <div class="p-6 border-b border-gray-700/50">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                        Registro de Accesos en Tiempo Real
                    </h2>
                    <span class="text-sm text-gray-500">√öltimos 50 registros</span>
                </div>
            </div>

            <div class="overflow-y-auto max-h-[500px] scrollbar-thin">
                <table class="w-full">
                    <thead class="sticky top-0 bg-gray-800/90 backdrop-blur">
                        <tr class="text-left text-xs text-gray-400 uppercase tracking-wider">
                            <th class="px-6 py-3">Hora</th>
                            <th class="px-6 py-3">UID</th>
                            <th class="px-6 py-3">Usuario</th>
                            <th class="px-6 py-3">Estado</th>
                        </tr>
                    </thead>
                    <tbody id="accessTableBody" class="divide-y divide-gray-700/50">
                        <!-- Initial data from server -->
                        <tr th:each="record : ${records}" class="hover:bg-gray-700/20 transition">
                            <td class="px-6 py-4">
                                <span class="text-gray-300" th:text="${record.time}">12:34:56</span>
                            </td>
                            <td class="px-6 py-4">
                                <code class="text-primary-300 bg-primary-500/10 px-2 py-1 rounded"
                                    th:text="${record.uid}">4A B1 C2 33</code>
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-gray-300" th:text="${record.userName}">Usuario</span>
                            </td>
                            <td class="px-6 py-4">
                                <span
                                    th:class="'px-3 py-1 rounded-full text-xs font-medium border status-' + ${record.statusClass}"
                                    th:text="${record.status}">Permitido</span>
                            </td>
                        </tr>

                        <!-- Empty state -->
                        <tr th:if="${#lists.isEmpty(records)}" id="emptyRow">
                            <td colspan="4" class="px-6 py-12 text-center">
                                <svg class="w-12 h-12 mx-auto text-gray-600 mb-3" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                </svg>
                                <p class="text-gray-500">Esperando lecturas del sensor...</p>
                                <p class="text-sm text-gray-600 mt-1">Los accesos aparecer√°n aqu√≠ en tiempo real</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Stop Confirmation Modal -->
    <div id="stopModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="glass-card rounded-2xl p-6 max-w-md mx-4">
            <div class="text-center">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500/20 flex items-center justify-center">
                    <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="text-xl font-semibold mb-2">¬øDetener Sesi√≥n?</h3>
                <p class="text-gray-400 mb-6">
                    Se cerrar√° la conexi√≥n serial y se guardar√° el archivo CSV actual.
                </p>
                <div class="flex gap-3">
                    <button onclick="closeModal()"
                        class="flex-1 px-4 py-2 rounded-lg bg-gray-700/50 hover:bg-gray-600/50 transition">
                        Cancelar
                    </button>
                    <button onclick="stopSession()"
                        class="flex-1 px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 transition text-white">
                        Detener
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 hidden glass-card rounded-xl p-4 max-w-sm z-50 fade-in">
        <div class="flex items-center gap-3">
            <div id="toastIcon" class="w-8 h-8 rounded-lg flex items-center justify-center"></div>
            <div>
                <p id="toastTitle" class="font-medium"></p>
                <p id="toastMessage" class="text-sm text-gray-400"></p>
            </div>
        </div>
    </div>

    <!-- Enrollment Confirmation Modal -->
    <div id="enrollModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="glass-card rounded-2xl p-6 max-w-md mx-4 w-full">
            <div class="text-center">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-emerald-500/20 flex items-center justify-center">
                    <svg class="w-8 h-8 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                </div>
                <h3 class="text-xl font-semibold mb-2">Dispositivo Detectado</h3>
                <p class="text-gray-400 mb-4">UID capturado:</p>
                <code id="capturedUidDisplay"
                    class="block text-lg text-primary-300 bg-primary-500/10 px-4 py-2 rounded-lg mb-6">XX XX XX XX</code>

                <div class="mb-6">
                    <label class="block text-left text-sm text-gray-400 mb-2">Nombre del usuario</label>
                    <input type="text" id="enrollUserName"
                        class="w-full px-4 py-3 rounded-lg bg-gray-800/50 border border-gray-700 focus:border-primary-500 focus:outline-none text-white placeholder-gray-500"
                        placeholder="Ej: Juan Garc√≠a">
                </div>

                <div class="flex gap-3">
                    <button onclick="cancelEnrollmentModal()"
                        class="flex-1 px-4 py-3 rounded-lg bg-gray-700/50 hover:bg-gray-600/50 transition btn-touch">
                        Cancelar
                    </button>
                    <button onclick="confirmEnrollment()"
                        class="flex-1 px-4 py-3 rounded-lg bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 transition text-white font-medium btn-touch">
                        Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Device Confirmation Modal -->
    <div id="deleteDeviceModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="glass-card rounded-2xl p-6 max-w-md mx-4 w-full">
            <div class="text-center">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500/20 flex items-center justify-center">
                    <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </div>
                <h3 class="text-xl font-semibold mb-2">¬øEliminar Dispositivo?</h3>
                <p class="text-gray-400 mb-2">Se eliminar√° el siguiente dispositivo:</p>
                <code id="deleteUidDisplay"
                    class="block text-primary-300 bg-primary-500/10 px-4 py-2 rounded-lg mb-2">XX XX XX XX</code>
                <p id="deleteUserNameDisplay" class="text-white font-medium mb-6">Nombre Usuario</p>

                <div class="flex gap-3">
                    <button onclick="closeDeleteModal()"
                        class="flex-1 px-4 py-3 rounded-lg bg-gray-700/50 hover:bg-gray-600/50 transition btn-touch">
                        Cancelar
                    </button>
                    <button onclick="confirmDeleteDevice()"
                        class="flex-1 px-4 py-3 rounded-lg bg-red-500 hover:bg-red-600 transition text-white font-medium btn-touch">
                        Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Reconnect Arduino Modal -->
    <div id="reconnectModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="glass-card rounded-2xl p-6 max-w-md mx-4 w-full">
            <div class="text-center">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-amber-500/20 flex items-center justify-center">
                    <svg class="w-8 h-8 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </div>
                <h3 class="text-xl font-semibold mb-2">Reconectar Arduino</h3>
                <p class="text-gray-400 mb-4">Seleccione el puerto para reconectar.<br>El CSV actual se mantendr√°.</p>

                <!-- Port Selection for Reconnect -->
                <div class="mb-4">
                    <div id="reconnectPortsList"
                        class="rounded-lg bg-gray-800/30 border border-gray-700/50 max-h-48 overflow-y-auto scrollbar-thin text-left">
                        <p class="text-gray-500 text-sm p-4 text-center">Cargando puertos...</p>
                    </div>
                </div>

                <div id="reconnectSelectedInfo"
                    class="hidden mb-4 px-3 py-2 rounded-lg bg-amber-500/10 border border-amber-500/30">
                    <div class="flex items-center gap-2 justify-center">
                        <svg class="w-4 h-4 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <span id="reconnectSelectedPortText" class="text-sm text-amber-300"></span>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="closeReconnectModal()"
                        class="flex-1 px-4 py-3 rounded-lg bg-gray-700/50 hover:bg-gray-600/50 transition btn-touch">
                        Cancelar
                    </button>
                    <button id="reconnectBtn" onclick="reconnectArduino()" disabled
                        class="flex-1 px-4 py-3 rounded-lg bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 transition text-white font-medium btn-touch disabled:opacity-50 disabled:cursor-not-allowed">
                        Reconectar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let socket = null;
        let recordCount = parseInt(document.getElementById('recordCount').textContent) || 0;

        // Update current time
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent =
                now.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }
        updateTime();
        setInterval(updateTime, 1000);

        // WebSocket connection
        function connectWebSocket() {
            const wsStatus = document.getElementById('wsStatus');
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/access`;

            socket = new WebSocket(wsUrl);

            socket.onopen = function () {
                console.log('WebSocket connected');
                wsStatus.className = 'flex items-center space-x-2 px-3 py-1.5 rounded-lg bg-green-500/20 border border-green-500/40';
                wsStatus.innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-green-400 pulse-dot"></div>
                    <span class="text-sm text-green-300">En vivo</span>
                `;
            };

            socket.onclose = function () {
                console.log('WebSocket disconnected');
                wsStatus.className = 'flex items-center space-x-2 px-3 py-1.5 rounded-lg bg-red-500/20 border border-red-500/40';
                wsStatus.innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-red-400"></div>
                    <span class="text-sm text-red-300">Desconectado</span>
                `;

                // Reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };

            socket.onerror = function (error) {
                console.error('WebSocket error:', error);
            };

            socket.onmessage = function (event) {
                const message = JSON.parse(event.data);

                if (message.type === 'NEW_RECORD') {
                    addRecordToTable(message.data);
                    updateStats();
                } else if (message.type === 'SESSION_STATUS') {
                    if (!message.data.active) {
                        window.location.href = '/';
                    }
                } else if (message.type === 'ADMIN_REQUIRED') {
                    handleAdminRequired(message.data.secondsRemaining);
                } else if (message.type === 'ADMIN_APPROVED') {
                    handleAdminApproved();
                } else if (message.type === 'ADMIN_REJECTED') {
                    handleAdminRejected(message.data.message);
                } else if (message.type === 'ENROLLMENT_MODE') {
                    handleEnrollmentModeUpdate(message.data);
                } else if (message.type === 'UID_CAPTURED') {
                    handleUidCaptured(message.data.uid);
                } else if (message.type === 'ENROLLMENT_COMPLETE') {
                    handleEnrollmentComplete(message.data);
                } else if (message.type === 'ENROLLMENT_ERROR') {
                    handleEnrollmentError(message.data.message);
                } else if (message.type === 'USER_DELETED') {
                    handleUserDeleted(message.data.uid);
                } else if (message.type === 'BATCH_STARTED') {
                    handleBatchStarted();
                } else if (message.type === 'BATCH_COMPLETED') {
                    handleBatchCompleted(message.data);
                }
            };
        }

        // Add record to table
        function addRecordToTable(record) {
            const tbody = document.getElementById('accessTableBody');
            const emptyRow = document.getElementById('emptyRow');

            // Remove empty state
            if (emptyRow) {
                emptyRow.remove();
            }

            // Create new row
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-700/20 transition table-row-new';
            row.innerHTML = `
                <td class="px-6 py-4">
                    <span class="text-gray-300">${record.time}</span>
                </td>
                <td class="px-6 py-4">
                    <code class="text-primary-300 bg-primary-500/10 px-2 py-1 rounded">${record.uid}</code>
                </td>
                <td class="px-6 py-4">
                    <span class="text-gray-300">${record.userName}</span>
                </td>
                <td class="px-6 py-4">
                    <span class="px-3 py-1 rounded-full text-xs font-medium border status-${record.statusClass}">${record.status}</span>
                </td>
            `;

            // Insert at the beginning
            tbody.insertBefore(row, tbody.firstChild);

            // Limit to 50 rows
            while (tbody.children.length > 50) {
                tbody.removeChild(tbody.lastChild);
            }

            // Update record count
            recordCount++;
            document.getElementById('recordCount').textContent = recordCount + ' registros';

            // Show toast
            showToast(
                record.statusClass === 'success' ? 'success' : 'error',
                record.statusClass === 'success' ? 'Acceso Permitido' : 'Acceso Denegado',
                `${record.userName} - ${record.uid}`
            );
        }

        // Update stats
        async function updateStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();

                document.getElementById('statTotal').textContent = stats.totalAccesses;
                document.getElementById('statGranted').textContent = stats.grantedCount;
                document.getElementById('statDenied').textContent = stats.deniedCount;
                document.getElementById('statLastAccess').textContent = stats.lastAccessTime;
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Show toast notification
        function showToast(type, title, message) {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');

            const icons = {
                success: '<svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                error: '<svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                info: '<svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
            };

            const bgColors = {
                success: 'bg-green-500/20',
                error: 'bg-red-500/20',
                info: 'bg-blue-500/20'
            };

            toastIcon.className = `w-8 h-8 rounded-lg flex items-center justify-center ${bgColors[type]}`;
            toastIcon.innerHTML = icons[type];
            toastTitle.textContent = title;
            toastMessage.textContent = message;

            toast.classList.remove('hidden');
            toast.classList.add('flex');

            setTimeout(() => {
                toast.classList.add('hidden');
                toast.classList.remove('flex');
            }, 3000);
        }

        // Confirm stop
        function confirmStop() {
            document.getElementById('stopModal').classList.remove('hidden');
            document.getElementById('stopModal').classList.add('flex');
        }

        // Close modal
        function closeModal() {
            document.getElementById('stopModal').classList.add('hidden');
            document.getElementById('stopModal').classList.remove('flex');
        }

        // Stop session
        async function stopSession() {
            try {
                const response = await fetch('/api/session/stop', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    window.location.href = '/';
                } else {
                    showToast('error', 'Error', result.message);
                }
            } catch (error) {
                showToast('error', 'Error', 'No se pudo detener la sesi√≥n');
            }

            closeModal();
        }

        // Simulate access (for testing)
        async function simulateAccess() {
            try {
                const uids = ['4A B1 C2 33', 'FF 00 11 22', 'AB CD EF 99', '12 34 56 78'];
                const randomUid = uids[Math.floor(Math.random() * uids.length)];

                const formData = new FormData();
                formData.append('uid', randomUid);

                const response = await fetch('/api/test/access', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (!result.success) {
                    showToast('error', 'Error', result.message);
                }
            } catch (error) {
                showToast('error', 'Error', 'No se pudo simular el acceso');
            }
        }

        // Run manual batch
        async function runManualBatch() {
            try {
                showToast('info', 'Procesando', 'Ejecutando proceso batch...');

                const response = await fetch('/api/batch/run', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    showToast('success', 'Batch Completado', `${result.recordsProcessed} registros procesados`);
                } else {
                    showToast('error', 'Error', result.message);
                }
            } catch (error) {
                showToast('error', 'Error', 'No se pudo ejecutar el proceso batch');
            }
        }

        // ========== STOP SESSION ==========

        async function confirmStop() {
            if (!confirm('¬øDetener la sesi√≥n actual?')) return;
            try {
                const response = await fetch('/api/session/stop', { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    window.location.reload();
                } else {
                    showToast('error', 'Error', result.message);
                }
            } catch (error) {
                showToast('error', 'Error', 'No se pudo detener la sesi√≥n');
            }
        }

        // ========== SYSTEM STATUS ==========

        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/system/status');
                const data = await response.json();

                // Serial Listener
                const serialDot = document.getElementById('sysSerialDot');
                const serialInfo = document.getElementById('sysSerialInfo');
                if (data.serialListener.running) {
                    serialDot.className = 'w-2.5 h-2.5 rounded-full bg-green-400 pulse-dot';
                    serialInfo.textContent = `Activo en ${data.serialListener.port}`;
                    serialInfo.className = 'text-xs text-green-400/70 ml-5';
                } else {
                    serialDot.className = 'w-2.5 h-2.5 rounded-full bg-red-400';
                    serialInfo.textContent = 'Desconectado';
                    serialInfo.className = 'text-xs text-red-400/70 ml-5';
                }

                // Batch Processing
                const batchDot = document.getElementById('sysBatchDot');
                const batchInfo = document.getElementById('sysBatchInfo');
                if (data.batchProcessing.lastRunTime) {
                    const lastRun = new Date(data.batchProcessing.lastRunTime);
                    const timeStr = lastRun.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
                    const dateStr = lastRun.toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit' });
                    if (data.batchProcessing.lastRunSuccess) {
                        batchDot.className = 'w-2.5 h-2.5 rounded-full bg-green-400';
                        batchInfo.textContent = `√öltimo: ${dateStr} ${timeStr} (${data.batchProcessing.lastRunRecords} reg.) ‚Ä¢ Prog: ${data.batchProcessing.scheduledTime || '22:00'}`;
                        batchInfo.className = 'text-xs text-green-400/70 ml-5';
                    } else {
                        batchDot.className = 'w-2.5 h-2.5 rounded-full bg-red-400';
                        batchInfo.textContent = `Error: ${data.batchProcessing.lastRunError || 'Desconocido'}`;
                        batchInfo.className = 'text-xs text-red-400/70 ml-5';
                    }
                } else {
                    batchDot.className = 'w-2.5 h-2.5 rounded-full bg-yellow-400';
                    batchInfo.textContent = `Programado a las ${data.batchProcessing.scheduledTime || '22:00'} (sin ejecuciones)`;
                    batchInfo.className = 'text-xs text-yellow-400/70 ml-5';
                }

                // Update time input to match current schedule
                if (data.batchProcessing.scheduledTime) {
                    document.getElementById('batchTimeInput').value = data.batchProcessing.scheduledTime;
                }

                // Registered Users
                const usersInfo = document.getElementById('sysUsersInfo');
                usersInfo.textContent = `${data.registeredUsers} registrados`;
                usersInfo.className = 'text-xs text-indigo-400/70 ml-5';

                // WebSocket Clients
                const wsInfo = document.getElementById('sysWsInfo');
                wsInfo.textContent = `${data.connectedWebSocketClients} conectados`;
                wsInfo.className = 'text-xs text-amber-400/70 ml-5';

            } catch (error) {
                console.error('Error loading system status:', error);
            }
        }

        // Batch WebSocket handlers
        function handleBatchStarted() {
            const batchDot = document.getElementById('sysBatchDot');
            const batchInfo = document.getElementById('sysBatchInfo');
            batchDot.className = 'w-2.5 h-2.5 rounded-full bg-cyan-400 pulse-dot';
            batchInfo.textContent = 'Ejecutando...';
            batchInfo.className = 'text-xs text-cyan-400/70 ml-5';
            showToast('info', 'Batch Iniciado', 'Procesando archivos CSV...');
        }

        function handleBatchCompleted(data) {
            if (data.success) {
                showToast('success', 'Batch Completado', `${data.recordsProcessed} registros, ${data.errors} errores`);
            } else {
                showToast('error', 'Batch con Errores', `${data.recordsProcessed} registros, ${data.errors} errores`);
            }
            loadSystemStatus();
        }

        async function rescheduleBatch() {
            const timeInput = document.getElementById('batchTimeInput').value;
            if (!timeInput) {
                showToast('error', 'Error', 'Selecciona una hora v√°lida');
                return;
            }
            // Show admin auth modal
            document.getElementById('adminAuthModal').classList.remove('hidden');
            document.getElementById('adminUidInput').value = '';
            document.getElementById('adminUidInput').focus();
            window._pendingScheduleTime = timeInput;
        }

        function closeAdminModal() {
            document.getElementById('adminAuthModal').classList.add('hidden');
            window._pendingScheduleTime = null;
            window._awaitingAdminScan = false;
        }

        async function confirmScheduleChange() {
            const adminUid = document.getElementById('adminUidInput').value.trim();
            if (!adminUid) {
                showToast('error', 'Error', 'Ingresa el UID del administrador');
                return;
            }
            const timeInput = window._pendingScheduleTime;
            const [hour, minute] = timeInput.split(':').map(Number);
            try {
                const response = await fetch(`/api/system/batch/schedule?hour=${hour}&minute=${minute}&adminUid=${encodeURIComponent(adminUid)}`, { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    showToast('success', 'Horario Actualizado', result.message);
                    loadSystemStatus();
                } else {
                    showToast('error', 'Autorizaci√≥n Denegada', result.message);
                }
            } catch (error) {
                showToast('error', 'Error', 'No se pudo reprogramar el batch');
            }
            closeAdminModal();
        }

        // When admin modal is open and a tag is scanned, auto-fill the UID
        window._awaitingAdminScan = false;
        const _origOnMessage = null;
        function checkAdminScanFromWS(data) {
            const modal = document.getElementById('adminAuthModal');
            if (modal && !modal.classList.contains('hidden') && data.type === 'ACCESS') {
                document.getElementById('adminUidInput').value = data.data.uid || '';
                showToast('info', 'Tag Detectado', `UID: ${data.data.uid}`);
            }
        }

        // Initialize
        connectWebSocket();
        loadDevices();
        loadSystemStatus();
        // Refresh system status every 30 seconds
        setInterval(loadSystemStatus, 30000);

        // ========== DEVICE MANAGEMENT FUNCTIONS ==========
        let enrollmentActive = false;
        let waitingForAdmin = false;
        let capturedUid = null;
        let deleteUid = null;
        let deleteUserName = null;

        // ========== ADMIN VALIDATION HANDLERS ==========

        // Handle admin required
        function handleAdminRequired(secondsRemaining) {
            waitingForAdmin = true;
            enrollmentActive = true;
            showAdminBanner(true, secondsRemaining);
            showEnrollmentBanner(false, 0);
            updateEnrollButton(true);
        }

        // Handle admin approved
        function handleAdminApproved() {
            waitingForAdmin = false;
            showAdminBanner(false, 0);
            showToast('success', 'Admin Verificado', 'Ahora acerque el dispositivo a registrar');
        }

        // Handle admin rejected
        function handleAdminRejected(message) {
            waitingForAdmin = false;
            enrollmentActive = false;
            showAdminBanner(false, 0);
            showEnrollmentBanner(false, 0);
            updateEnrollButton(false);
            showToast('error', 'Acceso Denegado', message || 'La tarjeta no corresponde al administrador');
        }

        // Show/hide admin banner
        function showAdminBanner(show, seconds) {
            const banner = document.getElementById('adminBanner');
            const countdown = document.getElementById('adminCountdown');

            if (show) {
                banner.classList.remove('hidden');
                countdown.textContent = seconds;
            } else {
                banner.classList.add('hidden');
            }
        }

        // Load registered devices
        async function loadDevices() {
            try {
                const response = await fetch('/api/devices');
                const devices = await response.json();

                renderDevicesTable(devices);
            } catch (error) {
                console.error('Error loading devices:', error);
            }
        }

        // Render devices table
        function renderDevicesTable(devices) {
            const tbody = document.getElementById('devicesTableBody');
            const emptyRow = document.getElementById('devicesEmptyRow');

            if (!devices || devices.length === 0) {
                if (emptyRow) emptyRow.style.display = '';
                return;
            }

            if (emptyRow) emptyRow.style.display = 'none';

            // Clear existing rows (except empty row)
            const rows = tbody.querySelectorAll('tr:not(#devicesEmptyRow)');
            rows.forEach(row => row.remove());

            // Add devices
            devices.forEach(device => {
                const row = document.createElement('tr');
                row.className = 'device-row transition';
                row.id = `device-${device.uid.replace(/\s+/g, '-')}`;
                row.innerHTML = `
                    <td class="px-6 py-4">
                        <code class="text-primary-300 bg-primary-500/10 px-2 py-1 rounded">${device.uid}</code>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-gray-300">${device.name}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-gray-400 text-sm">${device.registeredAt}</span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="showDeleteModal('${device.uid}', '${device.name}')"
                            class="p-2 rounded-lg hover:bg-red-500/20 transition text-red-400 hover:text-red-300 btn-touch">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Start enrollment mode
        async function startEnrollment() {
            if (enrollmentActive) return;

            try {
                const response = await fetch('/api/devices/enrollment/start', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    enrollmentActive = true;
                    showEnrollmentBanner(true, 20);
                    updateEnrollButton(true);
                } else {
                    showToast('error', 'Error', result.message);
                }
            } catch (error) {
                showToast('error', 'Error', 'No se pudo iniciar el enrolamiento');
            }
        }

        // Cancel enrollment
        async function cancelEnrollment() {
            try {
                await fetch('/api/devices/enrollment/cancel', { method: 'POST' });
            } catch (error) {
                console.error('Error cancelling enrollment:', error);
            }

            enrollmentActive = false;
            showEnrollmentBanner(false, 0);
            updateEnrollButton(false);
        }

        // Show/hide enrollment banner
        function showEnrollmentBanner(show, seconds) {
            const banner = document.getElementById('enrollmentBanner');
            const countdown = document.getElementById('enrollCountdown');

            if (show) {
                // Also hide admin banner when enrollment banner shows
                showAdminBanner(false, 0);
                banner.classList.remove('hidden');
                countdown.textContent = seconds;
            } else {
                banner.classList.add('hidden');
            }
        }

        // Update enrollment button state
        function updateEnrollButton(active) {
            const btn = document.getElementById('enrollBtn');
            const btnText = document.getElementById('enrollBtnText');

            if (active) {
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.disabled = true;
                btnText.textContent = 'ESCANEANDO...';
            } else {
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.disabled = false;
                btnText.textContent = 'ESCANEAR NUEVO';
            }
        }

        // Handle enrollment mode WebSocket update
        function handleEnrollmentModeUpdate(data) {
            enrollmentActive = data.active;

            // Only show enrollment banner if not waiting for admin
            if (!waitingForAdmin) {
                showEnrollmentBanner(data.active, data.secondsRemaining);
            }
            updateEnrollButton(data.active);

            if (!data.active && !data.capturedUid && !waitingForAdmin) {
                // Enrollment ended without capturing - hide admin banner too
                showAdminBanner(false, 0);
                showToast('info', 'Tiempo agotado', 'No se detect√≥ ning√∫n dispositivo');
            }
        }

        // Handle UID captured
        function handleUidCaptured(uid) {
            capturedUid = uid;
            document.getElementById('capturedUidDisplay').textContent = uid;
            document.getElementById('enrollUserName').value = '';

            // Show enrollment modal
            document.getElementById('enrollModal').classList.remove('hidden');
            document.getElementById('enrollModal').classList.add('flex');

            // Focus on name input
            setTimeout(() => {
                document.getElementById('enrollUserName').focus();
            }, 100);
        }

        // Handle enrollment complete
        function handleEnrollmentComplete(user) {
            enrollmentActive = false;
            showEnrollmentBanner(false, 0);
            updateEnrollButton(false);
            closeEnrollModal();

            showToast('success', 'Dispositivo Registrado', `${user.name} - ${user.uid}`);

            // Reload devices table
            loadDevices();
        }

        // Handle enrollment error
        function handleEnrollmentError(message) {
            showToast('error', 'Error de Registro', message);
        }

        // Cancel enrollment modal
        function cancelEnrollmentModal() {
            closeEnrollModal();
            cancelEnrollment();
        }

        // Close enrollment modal
        function closeEnrollModal() {
            document.getElementById('enrollModal').classList.add('hidden');
            document.getElementById('enrollModal').classList.remove('flex');
            capturedUid = null;
        }

        // Confirm enrollment
        async function confirmEnrollment() {
            const name = document.getElementById('enrollUserName').value.trim();

            if (!name) {
                showToast('error', 'Error', 'Por favor ingrese un nombre');
                return;
            }

            if (!capturedUid) {
                showToast('error', 'Error', 'UID no capturado');
                return;
            }

            try {
                const response = await fetch('/api/devices/enrollment/confirm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ uid: capturedUid, name: name })
                });

                const result = await response.json();

                if (result.success) {
                    // Success handled by WebSocket
                } else {
                    showToast('error', 'Error', result.message);
                }
            } catch (error) {
                showToast('error', 'Error', 'No se pudo confirmar el registro');
            }
        }

        // Show delete modal
        function showDeleteModal(uid, userName) {
            deleteUid = uid;
            deleteUserName = userName;
            document.getElementById('deleteUidDisplay').textContent = uid;
            document.getElementById('deleteUserNameDisplay').textContent = userName;

            document.getElementById('deleteDeviceModal').classList.remove('hidden');
            document.getElementById('deleteDeviceModal').classList.add('flex');
        }

        // Close delete modal
        function closeDeleteModal() {
            document.getElementById('deleteDeviceModal').classList.add('hidden');
            document.getElementById('deleteDeviceModal').classList.remove('flex');
            deleteUid = null;
            deleteUserName = null;
        }

        // Confirm delete device
        async function confirmDeleteDevice() {
            if (!deleteUid) return;

            try {
                const response = await fetch(`/api/devices/${encodeURIComponent(deleteUid)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showToast('success', 'Dispositivo Eliminado', deleteUserName);
                    closeDeleteModal();
                    loadDevices();
                } else {
                    showToast('error', 'Error', result.message);
                }
            } catch (error) {
                showToast('error', 'Error', 'No se pudo eliminar el dispositivo');
            }
        }

        // Handle user deleted (WebSocket notification)
        function handleUserDeleted(uid) {
            // Remove row from table if visible
            const rowId = `device-${uid.replace(/\s+/g, '-')}`;
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
            }

            // Check if table is empty
            const tbody = document.getElementById('devicesTableBody');
            const remainingRows = tbody.querySelectorAll('tr:not(#devicesEmptyRow)');
            if (remainingRows.length === 0) {
                const emptyRow = document.getElementById('devicesEmptyRow');
                if (emptyRow) emptyRow.style.display = '';
            }
        }
    </script>



    <!-- Admin Authorization Modal -->
    <div id="adminAuthModal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="glass-card rounded-2xl p-6 w-full max-w-sm mx-4 border border-cyan-500/30 shadow-2xl">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-xl bg-cyan-600/30 flex items-center justify-center">
                    <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>
                <div>
                    <h3 class="text-white font-semibold">Autorizaci\u00f3n del Administrador</h3>
                    <p class="text-gray-400 text-xs">Escanea tu tag NFC o ingresa tu UID</p>
                </div>
            </div>
            <div class="mb-4">
                <label class="text-xs text-gray-400 block mb-1">UID del Administrador</label>
                <input type="text" id="adminUidInput" placeholder="Ej: EB-EE-C0-1"
                    class="w-full bg-gray-800/50 border border-gray-600 rounded-lg text-sm text-white px-3 py-2 focus:border-cyan-500 focus:outline-none placeholder-gray-600"
                    onkeydown="if(event.key==='Enter') confirmScheduleChange()" />
            </div>
            <div class="flex gap-3">
                <button onclick="closeAdminModal()"
                    class="flex-1 bg-gray-700/50 hover:bg-gray-600/50 text-gray-300 py-2 rounded-lg text-sm transition">
                    Cancelar
                </button>
                <button onclick="confirmScheduleChange()"
                    class="flex-1 bg-cyan-600 hover:bg-cyan-700 text-white py-2 rounded-lg text-sm font-medium transition">
                    Autorizar
                </button>
            </div>
        </div>
    </div>
    <!-- Configuration Modal -->
    <div id="configModal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div
            class="glass-card rounded-2xl p-6 w-full max-w-lg mx-4 border border-primary-500/30 shadow-2xl max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-primary-500/20 flex items-center justify-center">
                        <svg class="w-5 h-5 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-white font-semibold text-lg">Configuraci√≥n del Sistema</h3>
                        <p class="text-gray-400 text-xs">Puerto serial y nombre de sesi√≥n</p>
                    </div>
                </div>
                <button onclick="closeConfigModal()" class="text-gray-500 hover:text-white transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Step 1: Port Selection -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                    <label class="text-sm font-medium text-gray-300 flex items-center gap-2">
                        <span
                            class="flex items-center justify-center w-6 h-6 rounded-md bg-primary-500/20 text-primary-400 text-xs font-bold">1</span>
                        Puerto Serial
                    </label>
                    <button onclick="refreshModalPorts()"
                        class="text-xs text-gray-400 hover:text-white flex items-center gap-1 transition">
                        <svg id="modalRefreshIcon" class="w-3.5 h-3.5" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        Actualizar
                    </button>
                </div>

                <!-- Search -->
                <input type="text" id="modalPortSearch" placeholder="Buscar puerto o dispositivo..."
                    oninput="filterModalPorts()"
                    class="w-full px-4 py-2.5 rounded-lg bg-gray-800/70 border border-gray-700/50 focus:border-primary-500 focus:ring-1 focus:ring-primary-500/20 transition outline-none text-white placeholder-gray-500 text-sm mb-2">

                <!-- Ports List -->
                <div id="modalPortsList"
                    class="rounded-lg bg-gray-800/30 border border-gray-700/50 max-h-48 overflow-y-auto scrollbar-thin">
                    <!-- Populated by JS -->
                </div>

                <!-- Selected Port -->
                <div id="modalSelectedPort"
                    class="hidden mt-2 px-3 py-2 rounded-lg bg-primary-500/10 border border-primary-500/30 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <span id="modalSelectedPortText" class="text-sm text-primary-300"></span>
                    </div>
                    <button onclick="clearModalPortSelection()"
                        class="text-xs text-gray-500 hover:text-gray-300 transition">Cambiar</button>
                </div>
            </div>

            <!-- Step 2: Session Name -->
            <div class="mb-6">
                <label class="text-sm font-medium text-gray-300 flex items-center gap-2 mb-3">
                    <span
                        class="flex items-center justify-center w-6 h-6 rounded-md bg-primary-500/20 text-primary-400 text-xs font-bold">2</span>
                    Nombre de la Sesi√≥n
                </label>
                <div class="relative">
                    <input type="text" id="modalSessionName" placeholder="ej: registro_acceso_feb12"
                        class="w-full px-4 py-2.5 pr-12 rounded-lg bg-gray-800/70 border border-gray-700/50 focus:border-primary-500 focus:ring-1 focus:ring-primary-500/20 transition outline-none text-white placeholder-gray-500 text-sm">
                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-600 text-sm">.csv</span>
                </div>
                <p class="text-xs text-gray-600 mt-1">El archivo se guardar√° en data_logs/ con la fecha actual</p>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3">
                <button onclick="closeConfigModal()"
                    class="flex-1 bg-gray-700/50 hover:bg-gray-600/50 text-gray-300 py-3 rounded-xl text-sm transition">
                    Cancelar
                </button>
                <button id="modalStartBtn" onclick="startSessionFromModal()"
                    class="flex-1 bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white py-3 rounded-xl text-sm font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                    Iniciar Sesi√≥n
                </button>
            </div>

            <!-- Rename Section (solo si hay sesi√≥n activa) -->
            <div id="renameSection" class="hidden mt-6 pt-6 border-t border-gray-700/50">
                <label class="text-sm font-medium text-gray-300 flex items-center gap-2 mb-3">
                    <svg class="w-4 h-4 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                    Renombrar sesi√≥n activa
                </label>
                <div class="flex gap-2">
                    <input type="text" id="renameInput" placeholder="Nuevo nombre..."
                        class="flex-1 px-4 py-2 rounded-lg bg-gray-800/70 border border-gray-700/50 focus:border-yellow-500 focus:ring-1 focus:ring-yellow-500/20 transition outline-none text-white placeholder-gray-500 text-sm">
                    <button onclick="renameSession()"
                        class="px-4 py-2 rounded-lg bg-yellow-500/20 hover:bg-yellow-500/30 border border-yellow-500/30 text-yellow-300 text-sm font-medium transition">
                        Renombrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Config Modal JavaScript -->
    <script>
        let modalSelectedPort = null;
        let modalAllPorts = [];

        function openConfigModal() {
            document.getElementById('configModal').classList.remove('hidden');
            refreshModalPorts();

            // Check if session is active to show rename section
            fetch('/api/session/status')
                .then(r => r.json())
                .then(status => {
                    const renameSection = document.getElementById('renameSection');
                    const startBtn = document.getElementById('modalStartBtn');
                    if (status.active) {
                        renameSection.classList.remove('hidden');
                        startBtn.textContent = 'Sesi√≥n ya activa';
                        startBtn.disabled = true;
                    } else {
                        renameSection.classList.add('hidden');
                        startBtn.textContent = 'Iniciar Sesi√≥n';
                        updateModalStartButton();
                    }
                });
        }

        function closeConfigModal() {
            document.getElementById('configModal').classList.add('hidden');
        }

        async function refreshModalPorts() {
            const icon = document.getElementById('modalRefreshIcon');
            icon.classList.add('animate-spin');
            try {
                const response = await fetch('/api/ports/refresh', { method: 'POST' });
                modalAllPorts = await response.json();
                renderModalPorts(modalAllPorts);
            } catch (error) {
                console.error('Error:', error);
            } finally {
                icon.classList.remove('animate-spin');
            }
        }

        function renderModalPorts(ports) {
            const list = document.getElementById('modalPortsList');
            if (ports.length === 0) {
                list.innerHTML = '<div class="text-center py-6 text-gray-500 text-sm">No se encontraron puertos</div>';
                return;
            }
            list.innerHTML = ports.map(port => `
                <div class="modal-port-item flex items-center justify-between px-4 py-3 border-b border-gray-700/30 cursor-pointer hover:bg-gray-700/30 transition ${port.open ? 'opacity-40 cursor-not-allowed' : ''}"
                     data-port="${port.systemPortName}" data-desc="${port.descriptivePortName}"
                     onclick="${port.open ? '' : 'selectModalPort(this)'}">
                    <div class="flex items-center gap-3 min-w-0">
                        <div class="w-8 h-8 rounded-lg bg-primary-500/15 flex items-center justify-center flex-shrink-0">
                            <svg class="w-4 h-4 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                            </svg>
                        </div>
                        <div class="min-w-0">
                            <p class="font-medium text-white text-sm truncate">${port.descriptivePortName}</p>
                            <p class="text-xs text-gray-500">${port.systemPortName}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <span class="modal-port-status text-xs"></span>
                        ${port.open
                    ? '<span class="px-2 py-0.5 rounded-full bg-red-500/20 text-red-300 text-xs">En uso</span>'
                    : '<span class="px-2 py-0.5 rounded-full bg-green-500/20 text-green-300 text-xs">Disponible</span>'
                }
                        ${!port.open
                    ? '<button onclick="event.stopPropagation(); testModalPort(\'' + port.systemPortName + '\', this)" class="px-2 py-1 rounded-md bg-yellow-500/15 hover:bg-yellow-500/25 text-yellow-300 text-xs transition" title="Verificar firmware">Probar</button>'
                    : ''
                }
                    </div>
                </div>
            `).join('');
        }

        function filterModalPorts() {
            const search = document.getElementById('modalPortSearch').value.toLowerCase();
            document.querySelectorAll('.modal-port-item').forEach(item => {
                const port = item.dataset.port.toLowerCase();
                const desc = item.dataset.desc.toLowerCase();
                item.style.display = (port.includes(search) || desc.includes(search)) ? '' : 'none';
            });
        }

        function selectModalPort(el) {
            if (!el || el.classList.contains('opacity-40')) return;
            modalSelectedPort = el.dataset.port;
            const desc = el.dataset.desc;

            document.getElementById('modalSelectedPort').classList.remove('hidden');
            document.getElementById('modalSelectedPortText').textContent = desc + ' (' + modalSelectedPort + ')';
            document.getElementById('modalPortsList').style.display = 'none';
            document.getElementById('modalPortSearch').style.display = 'none';
            updateModalStartButton();
        }

        function clearModalPortSelection() {
            modalSelectedPort = null;
            document.getElementById('modalSelectedPort').classList.add('hidden');
            document.getElementById('modalPortsList').style.display = '';
            document.getElementById('modalPortSearch').style.display = '';
            updateModalStartButton();
        }

        function updateModalStartButton() {
            const name = document.getElementById('modalSessionName').value.trim();
            document.getElementById('modalStartBtn').disabled = !modalSelectedPort || !name;
        }

        // Listen for name input changes
        document.getElementById('modalSessionName')?.addEventListener('input', updateModalStartButton);

        async function testModalPort(portName, btn) {
            btn.textContent = '...';
            btn.disabled = true;
            const statusSpan = btn.closest('.modal-port-item').querySelector('.modal-port-status');
            try {
                const response = await fetch('/api/ports/test?portName=' + encodeURIComponent(portName), { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    statusSpan.textContent = '‚úÖ';
                    statusSpan.className = 'modal-port-status text-xs text-green-400';
                    btn.textContent = '‚úÖ';
                    btn.className = 'px-2 py-1 rounded-md bg-green-500/15 text-green-300 text-xs';
                    // Auto-select
                    selectModalPort(btn.closest('.modal-port-item'));
                } else {
                    statusSpan.textContent = '‚ùå';
                    statusSpan.className = 'modal-port-status text-xs text-red-400';
                    btn.textContent = 'Retry';
                    btn.disabled = false;
                }
            } catch (e) {
                btn.textContent = 'Error';
                btn.disabled = false;
            }
        }

        async function startSessionFromModal() {
            if (!modalSelectedPort) return;
            const name = document.getElementById('modalSessionName').value.trim();
            if (!name) return;

            const btn = document.getElementById('modalStartBtn');
            btn.textContent = 'Iniciando...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/session/start?portName=' + encodeURIComponent(modalSelectedPort) + '&sessionName=' + encodeURIComponent(name), { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    window.location.reload();
                } else {
                    alert('Error: ' + result.message);
                    btn.textContent = 'Iniciar Sesi√≥n';
                    btn.disabled = false;
                }
            } catch (e) {
                alert('Error de conexi√≥n');
                btn.textContent = 'Iniciar Sesi√≥n';
                btn.disabled = false;
            }
        }

        async function renameSession() {
            const newName = document.getElementById('renameInput').value.trim();
            if (!newName) return;

            try {
                const response = await fetch('/api/session/rename?newName=' + encodeURIComponent(newName), { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    window.location.reload();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (e) {
                alert('Error de conexi√≥n');
            }
        }

        // === RECONNECT ARDUINO ===
        let reconnectSelectedPort = null;

        function openReconnectModal() {
            document.getElementById('reconnectModal').classList.remove('hidden');
            document.getElementById('reconnectModal').classList.add('flex');
            reconnectSelectedPort = null;
            document.getElementById('reconnectBtn').disabled = true;
            document.getElementById('reconnectSelectedInfo').classList.add('hidden');
            loadReconnectPorts();
        }

        function closeReconnectModal() {
            document.getElementById('reconnectModal').classList.add('hidden');
            document.getElementById('reconnectModal').classList.remove('flex');
        }

        async function loadReconnectPorts() {
            try {
                const response = await fetch('/api/ports/refresh', { method: 'POST' });
                const ports = await response.json();
                const list = document.getElementById('reconnectPortsList');

                if (ports.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 text-sm p-4 text-center">No se encontraron puertos</p>';
                    return;
                }

                list.innerHTML = ports.map(p => `
                    <div class="reconnect-port-item px-4 py-3 border-b border-gray-700/30 hover:bg-gray-700/30 cursor-pointer transition"
                         onclick="selectReconnectPort(this, '${p.systemPortName}')">
                        <div class="flex items-center justify-between">
                            <div>
                                <span class="text-sm font-medium text-white">${p.systemPortName}</span>
                                <span class="text-xs text-gray-500 ml-2">${p.descriptivePortName || ''}</span>
                            </div>
                            <div class="w-2 h-2 rounded-full bg-gray-600"></div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                document.getElementById('reconnectPortsList').innerHTML =
                    '<p class="text-red-400 text-sm p-4 text-center">Error al cargar puertos</p>';
            }
        }

        function selectReconnectPort(el, portName) {
            document.querySelectorAll('.reconnect-port-item').forEach(item => {
                item.classList.remove('bg-amber-500/10', 'border-amber-500/30');
            });
            el.classList.add('bg-amber-500/10', 'border-amber-500/30');
            reconnectSelectedPort = portName;
            document.getElementById('reconnectBtn').disabled = false;
            document.getElementById('reconnectSelectedInfo').classList.remove('hidden');
            document.getElementById('reconnectSelectedPortText').textContent = portName + ' seleccionado';
        }

        async function reconnectArduino() {
            if (!reconnectSelectedPort) return;
            const btn = document.getElementById('reconnectBtn');
            btn.textContent = 'Reconectando...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/session/reconnect?portName=' + encodeURIComponent(reconnectSelectedPort), { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    closeReconnectModal();
                    showToast('success', '‚ü≥ Arduino Reconectado', result.message);
                    // Reload to update connection status
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    alert('Error: ' + result.message);
                    btn.textContent = 'Reconectar';
                    btn.disabled = false;
                }
            } catch (e) {
                alert('Error de conexi√≥n');
                btn.textContent = 'Reconectar';
                btn.disabled = false;
            }
        }
    </script>

</body>

</html>